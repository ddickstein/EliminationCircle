<h1><%= @game.name %></h1>
<% if not @game.started? and @game.user != current_user %>
  <%= @game.user.first_name %>'s game has not yet started!  Check back soon!
<% elsif @game.started? or @game.preregistered? %>
  <table>
    <tr class="headers">
      <th class="status">Status</th>
      <th>Player</th>
      <% if @game.user == current_user %>
        <th>Target</th>
        <% unless @game.parameters.blank? %>
          <% @game.parameters.split(", ").each do |header| %>
            <th><%= header.capitalize %></th>
          <% end %>
        <% end %>
      <% end %>
      <th>Kills</th>
      <% if @game.user == current_user %>
        <th></th> <!-- Kill button -->
      <% end %>
    </tr>
    <% @players.each_with_index do |player, index| %>
      <tr class="<%= index % 2 == 0 ? 'even' : 'odd' %>">
        <% if player.is_alive? %>
          <td class="status"><%= image_tag 'alive.png', :size => '50' %></td>
        <% else %>
          <td class="status"><%= image_tag 'dead.png', :size => '50' %></td>
        <% end %>
        <td class="player-name"><%= player.full_name %></td>
        <% if @game.user == current_user %>
          <td class="target-name"><%= player.is_alive? ? player.target.full_name : '---' %></td>
          <% unless @game.parameters.blank? %>
            <% player.details.split(",").each do |detail| %>
              <td><%= detail %></td>
            <% end %>
          <% end %>
        <% end %>
        <td><%= player.kills %></td>
        <% if @game.user == current_user %>
          <% if player.is_alive? %>
            <td>
              <%= link_to(
                image_tag('kill.png', :size => '50', :class => 'kill-button'),
                kill_game_path(params: {player_id: player.target.id}),
                :method => 'delete',
                :class => 'kill-link'
                ) %>
            </td>
          <% else %>
            <td class="time"><%= raw player.died_at.strftime("%b %-d,<br />%l:%M%P") %></td>
          <% end %>
        <% end %>
      </tr>
    <% end %>
  </table>
  <br />
  <% if @game.user == current_user %>
    <p>
      Copy this page's URL and send it to the players of the game so they can
      check back here and see the current scoreboard.
    </p>
  <% end %>
  <%= render :partial => 'delete_button', :locals => {:game => @game} %>

  <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
      var killBlock = true // disable standard execution of kill button
      $('a.kill-link').on('click',function() {
        if (killBlock) {
          deathButton = $(this)
          playerName = $(this).parent().parent().find('td.player-name').text()
          targetName = $(this).parent().parent().find('td.target-name').text()
          $.jconfirm({
            title: 'Confirm that ' + playerName + ' killed ' + targetName + '?',
            confirm: 'Yes',
            cancel: 'No',
          }, function() {
            killBlock = false // enable standard execution of kill button
            deathButton[0].click()
          })
          return false
        }
      })
    })
  </script>
<% else %> <!-- This user is the admin, the game has not started, and the game
                was not preregistered.  -->
  Send the following link to anyone you would like to invite:
  <%= link_to @signup_url, @signup_url, :target => "_blank" %><br /><br />
  
  <% if @game.players.any? %>
    <h3>People who have joined so far:</h3>
    <table>
      <% @game.players.each_with_index do |player,index| %>
        <tr class="<%= index % 2 == 0 ? 'even' : 'odd' %>">
          <td class="player-name"><%= player.full_name %></td>
          <td><%= link_to 'Remove',{
            controller: 'games',
            action:     'remove_player',
            id:         @game.permalink,
            profile_id: player.id,
          }, { :method => 'delete', :class => 'button red-button' } %>
          </td>
        </tr>
      <% end %>
    </table>
    <br />
    <script type="text/javascript" charset="utf-8">
      $(document).ready(function() {
        var removePlayerBlock = true // disable standard execution of remove
                                     // button
        $('a.red-button').on('click',function() {
          if (removePlayerBlock) {
            selectedButton = $(this)
            playerName = $(this).closest("tr").find(".player-name").text()
            $.jconfirm({
              title: 'Are you sure you want to remove ' + playerName +
                     ' from the game?',
              confirm: 'Yes',
              cancel: 'No',
            }, function() {
              removePlayerBlock = false // enable standard execution of remove
                                        // button
              selectedButton.click()
            })
            return false
          }
        })
      })
    </script>
  <% else %>
    Currently, no players have joined the game.<br /><br />
  <% end %>
  <% if @game.players.count >= 2 %>
    <div id="complete-registration-link-box">
      Once all the players have joined the game,
      <%= link_to 'click here', '#', :id => 'complete-registration-link' %>
      to complete the setup process.
    </div>
    <div id="setup-completion-box" class="slidedown-box">
      <%= form_tag launch_game_path(@game), :method => 'post', :id => 'param-form' do %>
      <%= render :partial => 'parameter_lists' %>
      <%= link_to "Start Game", '#', :id => 'start-button', :class => 'button green-button large-button' %>
      <% end %>
    </div>
  
    <script type="text/javascript" charset="utf-8">
      $(document).ready(function() {
        $("#complete-registration-link").on('click',function() {
          $("#complete-registration-link-box").fadeOut("3000",function() {
            $("#setup-completion-box").fadeIn("3000")
          })
          return false
        })
        $("#start-button").on('click',function() {
          $("#param-form").submit()
        })
      })
    </script>
  <% end%>
<% end %>